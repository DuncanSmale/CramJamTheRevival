<% layout('layouts/boilerplate') -%>
<%const date=meeting.start.getFullYear()+'/'+String(meeting.start.getMonth()+1).padStart(2,'0')+'/'+String(meeting.start.getDate()).padStart(2,'0')%>
<%const startTime=String(meeting.start.getHours()).padStart(2,'0')+':'+String(meeting.start.getMinutes()).padStart(2,'0')%>
<%const endTime=String(meeting.end.getHours()).padStart(2,'0')+':'+String(meeting.end.getMinutes()).padStart(2,'0')%>
<div class="container">
    <div class="row justify-content-center">
        <div class="col-lg-7 card p-3 m-3">
            <h1 style="padding-bottom: 0px;">
                <%= meeting.name%>
            </h1>
            <h6>
                Meeting with <strong><a href="/groups/<%=meeting.group._id%>" class="profile-link"><%= meeting.group.name%></a></strong>.
            </h6>
            <h6>
                <strong>
                    <%= date%>
                </strong> From <strong>
                    <%=startTime%>
                </strong> to <strong>
                    <%=endTime%>
                </strong>
            </h6>
            <h4>
                <% if(meeting.location.type == 'Point') {%>
                    <span class="badge rounded-pill bg-success">In Person</span><% }else{ %> <span class="badge rounded-pill bg-primary">Online</span> <% }%>
                <% const now = new Date() %>
                <% if(meeting.start.getFullYear() == now.getFullYear() && meeting.start.getMonth() == now.getMonth() && meeting.start.getDate() == now.getDate()) { %>
                    <span class="badge rounded-pill bg-danger">Today</span>
                <%} %>
            </h4>
            <hr>
            <h4>Description</h4>
            <p>
                <%= meeting.description %>
            </p>
            <hr>
            <% if(inMeeting) { %> 
                <% if(meeting.location.type == 'Point') {%>
                    <h4>Covid screening 
                    </h4>
                    <div class="row">
                        <div class="col">
                            <span>
                                Covid Safe: <i><%= covidSafe ? 'Approved' : 'Not Approved' %></i>
                            </span>
                            <br>
                    <% if(!covidSafe){%>
                        <span><i style="color: red;"><%= covidMessage %></i></span>
                        <form action="/survey"><button class="btn bg-primary small-btn">Take Test</button></form>
                    <%} %>
                        </div>
                    </div>
                    <hr>
                <%} %>
                
         
               
                <h4>Location</h4>
                <% if(meeting.location.type == 'Point'){ %>
                    <div id="map"></div>
                    <div class="row">
                        <h5 id="address"></h5>
                    </div>
                <% }else{%>
                    <h5>Online</h5>
                <%}%>     
            <%} else {%>
                <form action="/meetings/<%= meeting._id %>" method="POST">
                    <button class="btn btn-primary small-btn">Attend</button>
                </form>
             <%}%> 
             <hr>
             <h4>Attendees</h4>
             
                 <div class="row">
                 <% for(let attendee of attendees) { %>
                    <div class="col-lg-12">
                        <div class="d-flex flex-row m-2 p-3 card align-items-center">
                            <div class="me-2">
                                <%- include('../partials/profilePicture', {student:attendee, width: 50, height: 50}) -%>
                            </div>
                            <div class="d-block">
                                <a href="\students\profile\<%=attendee._id%>" class="link-dark profile-link"><%= `${attendee.firstName} ${attendee.lastName} ` %>  <% if(attendee._id.equals(signedInUser._id)) {%>
                                        (you)
                                    <%}%>

                                </a>     
                                <br>
                                <span class="text-muted" style="font-size: small;">@<%=attendee.username %></span>
                                <% if(!allowedToAttend.includes(attendee._id)) { %> 
                                    <span class="badge rounded-pill bg-danger">Not Screened</span>
                                <% } else { %> 
                                    <span class="badge rounded-pill bg-success">Screened</span>
                                <% } %>
                            </div>
                        
                        </div>
                    </div> 
                 <% } %> 
            </div>
        </div>
    </div>
</div>

<script>
            let loc = JSON.parse('<%- JSON.stringify(meeting.location)%>')
            let coord = loc.coordinates
            mapboxgl.accessToken = 'pk.eyJ1Ijoiam9zaHVhdG9iaWFzIiwiYSI6ImNrbnRkM3ByZTAxdHgycHBzM3FkcGswZmMifQ.JyQyybatt9P0tqxlS7xU3w';
            let map = new mapboxgl.Map({
                container: 'map',
                style: 'mapbox://styles/mapbox/navigation-day-v1',
                center: coord,
                zoom: 12,
                dragPan: false,
                touchZoomRotate: { around: 'center' },
                scrollZoom: { around: 'center' }
            });

            // Create a default Marker and add it to the map.
            let marker = new mapboxgl.Marker({ color: 'red' })
                .setLngLat(coord)
                .addTo(map);
       

            (async function (coord){
                const apiUrl = `https://api.mapbox.com/geocoding/v5/mapbox.places/${coord[0]},${coord[1]}.json?types=address&access_token=pk.eyJ1Ijoiam9zaHVhdG9iaWFzIiwiYSI6ImNrbnRkM3ByZTAxdHgycHBzM3FkcGswZmMifQ.JyQyybatt9P0tqxlS7xU3w`
                const response = await fetch(apiUrl)
                const data = await response.json()
                
                const addr = document.getElementById('address')
                addr.innerHTML = data.features[0].place_name
            })(coord)
</script>